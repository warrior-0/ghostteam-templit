<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>홈 | 괴담지옥</title>
  <link rel="stylesheet" href="style.css" />
  <script src="main.js" defer></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      doc,
      setDoc,
      getDoc,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjHwHbHlCi4vgv-Ma0-3kqt-M3SLI_oF4",
      authDomain: "ghost-38f07.firebaseapp.com",
      projectId: "ghost-38f07",
      storageBucket: "ghost-38f07.firebasestorage.app",
      messagingSenderId: "776945022976",
      appId: "1:776945022976:web:105e545d39f12b5d0940e5",
      measurementId: "G-B758ZC971V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // 로그인 상태 감지 및 UI 업데이트
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        document.getElementById("userStatus").innerText = `로그인: ${user.email}`;
        document.getElementById("authSection").style.display = "none";
        document.getElementById("postSection").style.display = "block";
        loadPosts();
        loadComments();
        calculateAverageRating();
      } else {
        document.getElementById("userStatus").innerText = "로그인 필요";
        document.getElementById("authSection").style.display = "block";
        document.getElementById("postSection").style.display = "none";
      }
    });

    // --- 기존 회원가입, 로그인, 게시글, 댓글, 평점 함수 생략 ---

    // 인기 괴담 불러오기 (예: popularStories 컬렉션에서 조회)
    async function loadPopularStories() {
      const slider = document.getElementById("homeSlider");
      slider.innerHTML = "";  // 초기화

      try {
        // 예: 인기 괴담 컬렉션 이름이 'popularStories'라고 가정
        const colRef = collection(db, "popularStories");
        // 예: 평점 기준 내림차순으로 정렬해서 인기순으로 불러오기
        const q = query(colRef, orderBy("rating", "desc"), orderBy("created", "desc"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          slider.innerHTML = "<p>인기 괴담이 없습니다.</p>";
          return;
        }

        snapshot.forEach((doc) => {
          const data = doc.data();
          const card = document.createElement("div");
          card.className = "story-card";
          card.style = `
            border: 1px solid #ccc; padding: 10px; margin: 5px; border-radius: 6px; width: 220px;
          `;
          card.innerHTML = `
            <h3>${data.title || "제목 없음"}</h3>
            <p>${data.summary || "요약 정보 없음"}</p>
            <small>평점: ${data.rating || "N/A"} / 작성자: ${data.authorname || "익명"}</small><br/>
            <a href="story.html?id=${doc.id}">자세히 보기</a>
          `;
          slider.appendChild(card);
        });
      } catch (error) {
        console.error("인기 괴담 로딩 오류:", error);
        slider.innerHTML = "<p>인기 괴담을 불러오는 데 오류가 발생했습니다.</p>";
      }
    }

    window.onload = () => {
      // 별도 로그인, 게시글, 댓글, 평점 초기화 코드 생략
      loadPopularStories();  // 인기 괴담 불러오기 실행
    };
  </script>
</head>
<body>
  <!-- 기존 header, nav, main 구조 유지 -->
  <header>
    <!-- 생략 -->
  </header>

  <main>
    <section class="main-section">
      <h2 class="slider-title">인기 괴담</h2>
      <div class="slider-area">
        <div class="slider-arrow" id="sliderPrev">&lt;</div>
        <div class="product-slider-wrapper">
          <div class="product-slider" id="homeSlider">
            <!-- JS로 카드 삽입 -->
          </div>
        </div>
        <div class="slider-arrow" id="sliderNext">&gt;</div>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 괴담지옥. All rights reserved.
  </footer>
</body>
</html>
