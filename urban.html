<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>괴담 | 괴담지옥</title>
  <link rel="stylesheet" href="style.css" />
  <script src="main.js" defer></script>
  <!-- 반드시 type="module"로! -->
  <script type="module" src="urban.js"></script>
  <script type="module" src="urban-firebase.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      where,
      orderBy,
      doc,
      setDoc,
      getDoc,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjHwHbHlCi4vgv-Ma0-3kqt-M3SLI_oF4",
      authDomain: "ghost-38f07.firebaseapp.com",
      projectId: "ghost-38f07",
      storageBucket: "ghost-38f07.appspot.com",
      messagingSenderId: "776945022976",
      appId: "1:776945022976:web:105e545d39f12b5d0940e5",
      measurementId: "G-B758ZC971V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;
    let selectedRating = 0;

    // 회원가입
    async function signUp() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const nickname = document.getElementById("nickname").value.trim();

      if (!nickname) {
        alert("닉네임을 입력해주세요.");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, "users", user.uid), {
          email: user.email,
          nickname: nickname,
        });

        alert("회원가입 완료! 로그인되었습니다.");
      } catch (error) {
        alert("회원가입 오류: " + error.message);
      }
    }

    // 로그인
    async function signIn() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("로그인 성공!");
      } catch (error) {
        alert("로그인 오류: " + error.message);
      }
    }

    // 로그아웃
    async function signOutUser() {
      await signOut(auth);
      alert("로그아웃 되었습니다.");
    }

    // 게시글 불러오기
    async function loadPosts() {
      const postsRef = collection(db, "posts");
      const snapshot = await getDocs(postsRef);
      const list = document.getElementById("postList");
      if (list) list.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const item = document.createElement("li");
        item.innerHTML = `
          <a href="post.html?id=${docSnap.id}"><strong>${data.title}</strong></a>
          - 작성자: ${data.authorname || "익명"}
        `;
        if (currentUser && data.authorUid === currentUser.uid) {
          const editBtn = document.createElement("button");
          const deleteBtn = document.createElement("button");
          editBtn.textContent = "수정";
          deleteBtn.textContent = "삭제";
          editBtn.onclick = () => editPost(docSnap.id, data);
          deleteBtn.onclick = () => deletePost(docSnap.id);
          item.appendChild(editBtn);
          item.appendChild(deleteBtn);
        }
        if (list) list.appendChild(item);
      });
    }

    function editPost(postId, data) {
      const newTitle = prompt("새 제목을 입력하세요", data.title);
      const newContent = prompt("새 내용을 입력하세요", data.content);
      if (newTitle !== null && newContent !== null) {
        setDoc(doc(db, "posts", postId), {
          ...data,
          title: newTitle,
          content: newContent,
        }).then(() => {
          alert("게시글이 수정되었습니다.");
          loadPosts();
        });
      }
    }

    async function deletePost(postId) {
      if (confirm("정말로 이 게시글을 삭제하시겠습니까?")) {
        await deleteDoc(doc(db, "posts", postId));
        alert("게시글이 삭제되었습니다.");
        loadPosts();
      }
    }

    async function createPost() {
      if (!currentUser) {
        alert("로그인 후 작성 가능합니다.");
        return;
      }

      const title = document.getElementById("title").value.trim();
      const content = document.getElementById("content").value.trim();
      if (!title || !content) {
        alert("제목과 내용을 입력해주세요.");
        return;
      }

      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const nickname = userDoc.exists() ? userDoc.data().nickname : "익명";

      await addDoc(collection(db, "posts"), {
        title,
        content,
        authorUid: currentUser.uid,
        authorEmail: currentUser.email,
        authorname: nickname,
        created: new Date(),
      });

      alert("작성 완료!");
      document.getElementById("title").value = "";
      document.getElementById("content").value = "";
      loadPosts();
    }

    async function loadComments() {
      const q = query(collection(db, "comments"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      const list = document.getElementById("commentList");
      if (list) list.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `<strong>${data.authorname || "익명"}</strong>: ${data.comment}`;
        if (currentUser && data.uid === currentUser.uid) {
          const editBtn = document.createElement("button");
          const deleteBtn = document.createElement("button");
          editBtn.textContent = "수정";
          deleteBtn.textContent = "삭제";
          editBtn.onclick = () => editComment(docSnap.id, data);
          deleteBtn.onclick = () => deleteComment(docSnap.id);
          li.appendChild(editBtn);
          li.appendChild(deleteBtn);
        }
        if (list) list.appendChild(li);
      });
    }

    async function submitComment(event) {
      event.preventDefault();
      if (!currentUser) {
        alert("로그인 후 댓글 작성 가능합니다.");
        return;
      }

      const comment = document.getElementById("comment").value.trim();
      if (!comment) {
        alert("댓글을 입력해주세요.");
        return;
      }

      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const nickname = userDoc.exists() ? userDoc.data().nickname : "익명";

      await addDoc(collection(db, "comments"), {
        comment,
        authorname: nickname,
        uid: currentUser.uid,
        timestamp: new Date(),
      });

      alert("댓글 등록 완료!");
      document.getElementById("commentForm").reset();
      loadComments();
    }

    function editComment(commentId, data) {
      const newComment = prompt("댓글을 수정하세요", data.comment);
      if (newComment !== null) {
        setDoc(doc(db, "comments", commentId), {
          ...data,
          comment: newComment,
        }).then(() => {
          alert("댓글이 수정되었습니다.");
          loadComments();
        });
      }
    }

    async function deleteComment(commentId) {
      if (confirm("정말로 이 댓글을 삭제하시겠습니까?")) {
        await deleteDoc(doc(db, "comments", commentId));
        alert("댓글이 삭제되었습니다.");
        loadComments();
      }
    }

    async function submitRating() {
      if (!currentUser) {
        alert("로그인 후 평점 제출 가능합니다.");
        return;
      }

      if (isNaN(selectedRating) || selectedRating < 1 || selectedRating > 5) {
        alert("1 이상 5 이하의 평점을 입력해주세요.");
        return;
      }

      const ratingsRef = collection(db, "ratings");
      const q = query(ratingsRef, where("uid", "==", currentUser.uid));
      const snapshot = await getDocs(q);

      if (!snapshot.empty) {
        const ratingDoc = snapshot.docs[0];
        await setDoc(doc(db, "ratings", ratingDoc.id), {
          ...ratingDoc.data(),
          rating: selectedRating,
          timestamp: new Date(),
        });
        alert("평점이 수정되었습니다!");
      } else {
        await addDoc(ratingsRef, {
          rating: selectedRating,
          uid: currentUser.uid,
          timestamp: new Date(),
        });
        alert("평점이 저장되었습니다!");
      }

      await calculateAverageRating();
    }

    async function calculateAverageRating() {
      const snapshot = await getDocs(collection(db, "ratings"));
      let sum = 0;
      let count = 0;
      snapshot.forEach((doc) => {
        sum += doc.data().rating;
        count++;
      });
      const avg = count === 0 ? 0 : (sum / count).toFixed(1);
      const ratingDisplay = document.getElementById("avgRating");
      if (ratingDisplay) {
        ratingDisplay.innerText = `현재 평균 평점: ${avg}점`;
      }
    }

    window.onload = () => {
      const signUpBtn = document.getElementById("signUpBtn");
      const signInBtn = document.getElementById("signInBtn");
      const signOutBtn = document.getElementById("signOutBtn");

      signUpBtn.onclick = signUp;
      signInBtn.onclick = signIn;
      signOutBtn.onclick = signOutUser;

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        document.getElementById("userStatus").innerText = user ? `로그인: ${user.email}` : "로그인 필요";
        document.getElementById("authSection").style.display = user ? "none" : "block";
        signOutBtn.style.display = user ? "block" : "none";
        if (user) {
          loadPosts();
          loadComments();
          calculateAverageRating();
        }
      });

      const stars = document.querySelectorAll("#starRating .star");
      stars.forEach(star => {
        star.addEventListener("click", () => {
          selectedRating = parseInt(star.getAttribute("data-value"));
          stars.forEach(s => s.classList.remove("selected"));
          for (let i = 0; i < selectedRating; i++) {
            stars[i].classList.add("selected");
          }
        });
      });

      const commentForm = document.getElementById("commentForm");
      if (commentForm) {
        commentForm.addEventListener("submit", submitComment);
      }

      const ratingSubmit = document.getElementById("ratingSubmit");
      if (ratingSubmit) {
        ratingSubmit.onclick = submitRating;
      }

      const postCreateBtn = document.getElementById("postCreateBtn");
      if (postCreateBtn) {
        postCreateBtn.onclick = createPost;
      }
    };
  </script>
</head>

<body>
  <header>
    <div class="header-inner">
      <div style="display: flex; align-items: center;">
        <div id="menuContainer"></div>
        <a href="index.html" class="logo">괴담지옥</a>
        <nav>
          <!-- 메뉴 생략 -->
        </nav>
        <section id="authSection">
          <input type="email" size="10" id="email" placeholder="이메일" />
          <input type="password" size="10" id="password" placeholder="비밀번호" />
          <input type="text" size="8" id="nickname" placeholder="닉네임" />
          <button id="signUpBtn">회원가입</button>
          <button id="signInBtn">로그인</button>
          <button id="signOutBtn" style="display: none">로그아웃</button>
          <div id="userStatus">로그인 필요</div>
        </section>
      </div>
    </div>
  </header>

  <main>
    <section class="main-section">
      <h2 class="urban-title">괴담 모음</h2>
      <div class="urban-sort">
        <button class="sort-btn active" data-sort="latest">최신순</button>
        <button class="sort-btn" data-sort="popular">인기순</button>
        <button class="sort-btn" data-sort="level">공포 난이도순</button>
      </div>
      <div class="product-list" id="urbanList"></div>
    </section>
  </main>

  <footer>
    &copy; 2025 괴담지옥. All rights reserved.
  </footer>
</body>
</html>
